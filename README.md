# Room-Stat - IoT устройство для мониторинга микроклимата

## Общая информация

**Room-Stat** - это IoT-устройство для мониторинга параметров помещения, построенное на базе ESP32. Проект представляет собой систему сбора и передачи данных о температуре, влажности и освещенности в помещении.

## Технические характеристики

### Аппаратная платформа
- **Микроконтроллер**: ESP32 (esp32dev)
- **Фреймворк**: Arduino
- **Скорость мониторинга**: 115200 baud

### Используемые библиотеки
- `adafruit/DHT sensor library@^1.4.6` - для работы с датчиком DHT22
- `adafruit/Adafruit Unified Sensor@^1.1.4` - унифицированный интерфейс для датчиков
- `adafruit/Adafruit SSD1306@^2.5.9` - драйвер для OLED дисплея
- `adafruit/Adafruit GFX Library@^1.11.9` - графическая библиотека
- `bblanchon/ArduinoJson@^6.21.3` - работа с JSON

## Архитектура проекта

### Структура проекта
Проект организован по принципу модульной архитектуры с четким разделением ответственности:

```
room-stat/
├── include/          # Заголовочные файлы
├── src/             # Исходный код
├── lib/             # Библиотеки
├── test/            # Тесты
└── platformio.ini   # Конфигурация PlatformIO
```

### Основные компоненты

#### 1. **App** - Главный класс приложения
- Координирует работу всех компонентов
- Управляет жизненным циклом приложения (setup/loop)
- Инициализирует все сервисы и процессы

#### 2. **Services** - Сервисы для работы с периферией

**DHTService** - работа с датчиком DHT22
- Пин: GPIO 4
- Тип: DHT22
- Измеряет: температуру (-40°C до 80°C) и влажность (0-100%)
- Обработка ошибок при некорректных данных

**LDRService** - работа с датчиком освещенности
- Пин: GPIO 34 (ADC)
- Преобразует аналоговые значения в проценты (1-100%)
- Использует 12-битный АЦП ESP32

**DisplayService** - управление OLED дисплеем
- Разрешение: 128x32 пикселя
- Адрес: 0x3C
- Функции: отображение сообщений, логотипа, параметров, индикаторов состояния

**ApiService** - HTTP-клиент для API
- Поддержка GET и POST запросов
- Автоматическое добавление токена авторизации
- Обработка сетевых ошибок

#### 3. **Network** - Сетевые компоненты

**AccessPointManager** - точка доступа для настройки
- SSID: "Room_Stat_Access"
- Веб-интерфейс на 192.168.4.1
- Форма настройки Wi-Fi и кода устройства

**WiFiPointManager** - подключение к Wi-Fi
- Автоматические попытки подключения (до 3 раз)
- Таймаут подключения: 10 секунд
- Проверка статуса соединения

#### 4. **Processes** - Бизнес-логика

**DataCollectingProcess** - сбор данных с датчиков
- Объединяет данные с DHT22 и LDR
- Возвращает структуру DataConfig

**TransmitDataProcess** - передача данных на сервер
- Endpoint: `/room-stat/api/v1/transmit`
- Формат: JSON с temperature, humidity, light
- Требует авторизации

**VizualizationDataProcess** - отображение данных
- Форматирует данные для дисплея
- Показывает статус Wi-Fi соединения

**AuthProcess** - авторизация устройства
- Endpoint: `/core/api/v1/tools/auth`
- Отправляет type и code устройства
- Получает токен для последующих запросов

**ConnectionProcess** - управление подключениями
- Автоматическое переключение между Wi-Fi и AP режимом
- Загрузка конфигурации из памяти

**HealthCheckProcess** - проверка доступности сервера
- Endpoint: `/core/api/v1/health-check`
- Обновляет глобальное состояние serverAlive

#### 5. **Storage** - Хранение данных

**ToolPreferences** - постоянное хранение настроек
- Использует ESP32 Preferences API
- Сохраняет: code, wifi_ssid, wifi_pass
- Namespace: "setup"

#### 6. **DTO** - Структуры данных

**DataConfig** - данные с датчиков
```cpp
struct DataConfig {
    float temperature;
    float humidity;
    int light;
};
```

**ToolConfig** - конфигурация устройства
```cpp
struct ToolConfig {
    String type = "room-stat";
    String code;
    String wifi_ssid;
    String wifi_pass;
};
```

#### 7. **Validators** - Валидация данных

**ToolPreferencesValidator** - проверка входных данных
- Code: ровно 9 символов
- SSID: 3-32 символа
- Password: 3-32 символа

#### 8. **HTML** - Веб-интерфейс

- **ToolConfigSetupHtml** - форма настройки устройства
- **ValidationErrorHtml** - страница ошибки валидации
- **ValidationSuccessHtml** - страница успешной настройки
- **RebootingHtml** - страница перезагрузки

## Алгоритм работы

### 1. Инициализация
1. Запуск дисплея и отображение "Setup"
2. Инициализация датчика DHT22
3. Попытка подключения к Wi-Fi
4. Проверка доступности сервера
5. Авторизация устройства
6. Отображение "Ready!"

### 2. Основной цикл
1. Обработка веб-запросов (если в режиме AP)
2. Сбор данных с датчиков
3. Если нет Wi-Fi - попытка подключения
4. Передача данных на сервер
5. Отображение данных на дисплее
6. Пауза 2 секунды

### 3. Настройка устройства
1. Подключение к AP "Room_Stat_Access"
2. Открытие 192.168.4.1 в браузере
3. Ввод кода устройства и Wi-Fi данных
4. Валидация и сохранение настроек
5. Перезагрузка устройства

## API интеграция

### Сервер
- **Базовый URL**: https://dev.wstreet.systems
- **Dashboard**: www.wstreetsmartlab.systems

### Endpoints
- `GET /core/api/v1/health-check` - проверка доступности
- `POST /core/api/v1/tools/auth` - авторизация устройства
- `POST /room-stat/api/v1/transmit` - передача данных

### Формат данных
```json
{
  "temperature": 23.5,
  "humidity": 45.0,
  "light": 67
}
```

## Особенности реализации

### Безопасность
- Валидация всех входных данных
- Использование токенов авторизации
- Безопасное хранение Wi-Fi паролей

### Надежность
- Обработка ошибок датчиков
- Автоматические попытки переподключения
- Проверка доступности сервера

### Пользовательский опыт
- Интуитивный веб-интерфейс настройки
- Информативные сообщения на дисплее
- Автоматическое переключение режимов

## Возможности расширения

Проект имеет модульную архитектуру, что позволяет легко добавлять:
- Новые типы датчиков
- Дополнительные сетевые протоколы
- Расширенную визуализацию
- Локальное хранение данных
- Уведомления и алерты

## Сборка и развертывание

### Требования
- PlatformIO IDE или PlatformIO Core
- ESP32 совместимая плата
- Датчик DHT22
- Фоторезистор (LDR)
- OLED дисплей SSD1306

### Сборка
```bash
# Клонирование репозитория
git clone <repository-url>
cd room-stat

# Сборка проекта
pio run

# Загрузка на устройство
pio run --target upload

# Мониторинг порта
pio device monitor
```

## Лицензия

[Укажите лицензию проекта]

## Контакты

[Укажите контактную информацию] 